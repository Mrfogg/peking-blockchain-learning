## BTC协议

### 假如央行发数字货币

央行发布100元数字货币，数字货币上有央行私钥签名，央行公钥是公开的。所以我们可以验证100元的真伪。但是这没有解决双花问题，同样一个100块，可以无限复制，也叫double spending attack。数字货币面临的一个主要挑战就是double spending attack。

### 去中心化货币

需要解决两个问题

- 数字货币发行，谁有权力发行货币
- 验证交易的有效性，合法性。例如解决double spending attack

那么就需要维护一个数据结构，来记录某个币有没有被花过，被谁花过。这个数据结构为区块链。

### 数据结构

**BlockHeader**

| 字段                  | 说明                       |
| --------------------- | -------------------------- |
| version               | 协议版本                   |
| previous block hash   | 上一个区块header的哈希指针 |
| Mercle tree root hash | 根哈希                     |
| Target                | 挖矿用的目标值             |
| Nonce                 | 挖矿用的随机值             |

**BlockBody**

Body里存储交易列表

### 节点分类

**Full Node**

保存区块链所有信息

**Light Node**

只保存block header信息，并不参与区块链的构造和维护。

### 共识机制

区块链是一个分布式数据库，且各个机器的副本之间需要保持最终一致性，问题就在于一个交易是否合法，需要一个分布式共识算法。

**impossibility result**

在一个异步的系统里, 网络传输延迟没有上限，有一个成员有问题，那么不可能取得共识。

**cap theorm**

Consistency, Avalibility, Partition Tolerence。 这三个性质最多满足两个，不可能三个性质都满足。

#### BTC的共识协议

有些节点可能是由恶意，假设大多数节点是好的。

**投票是否可行**

比如一个候选区块，发布给所有的节点，每个节点检查里面的交易是否合法。如果都是合法，则投赞成票，否则投反对票，最后算一下得票超半数，则这个区块则写入区块链里。 

任何基于投票的方案，首先要确定谁有投票权。

- 联盟链，比如fabric。

BTC不可行，BTC产生一个账户不用通知别人，发生交易的时候才会被人知道。

那么，有恶意的节点就搞一个超级计算机，产生巨量的账户，然后拿到控制权操作投票结果，这种攻击叫**女巫攻击**

**按算力投票**

H(block header + nonce) <= target, 不停的尝试nonce，如果找到nonce满足不等式，即获得记账权，就是往账本里写下个区块的权力。其他节点收到这个区块需要验证区块的合法性。

验证

- block header nbits是否满足难度要求
- H(block header + nonce) <= target
- 验证交易是否合法，是否有双花问题。验证本区块到币的来源区块之间是否花过。
- 是否在最长合法链上，不在则拒绝此区块。

因为按算力投票，这避免了女巫攻击。

**分叉攻击**

通过往区块链中间位置插入区块，回滚已经发生的交易。正常情况下也会分叉，比如两个节点同时找到了满足条件的nonce, BTC节点默认情况下接受先来的区块。

**出块奖励**

BTC协议规定，获得记账权的节点，有一个特殊交易是铸币交易，可以发布一定数量的BTC。





